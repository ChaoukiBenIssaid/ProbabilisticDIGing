This is the simulation part.
